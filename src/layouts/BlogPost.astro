---
import { Image } from 'astro:assets'
import type { CollectionEntry } from 'astro:content'
import FormattedDate from '../components/FormattedDate.astro'
import BaseLayout from './BaseLayout.astro'

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: { depth: number; slug: string; text: string }[]
}

const { title, description, pubDate, updatedDate, heroImage, headings } =
	Astro.props

const structuredData = {
	'@context': 'https://schema.org',
	'@type': 'BlogPosting',
	headline: title,
	description: description,
	image: heroImage ? [new URL(heroImage.src, Astro.url).toString()] : [],
	datePublished: pubDate.toISOString(),
	...(updatedDate ? { dateModified: updatedDate.toISOString() } : {}),
	author: [
		{
			'@type': 'Person',
			name: 'milkmaccya',
			url: new URL('/about', Astro.url).toString(),
		},
	],
}
---

<BaseLayout
	title={title}
	description={description}
	structuredData={structuredData}
>
	<main class="max-w-full! px-0! md:px-4!">
		<article>
			<div class="w-full">
				{
					heroImage && (
						<Image
							width={1020}
							height={510}
							src={heroImage}
							alt=""
							class="block mx-auto rounded-xl shadow-md"
						/>
					)
				}
			</div>
			<div
				class="w-full max-w-[720px] mx-auto px-4 text-gray-700 prose md:prose-lg prose-headings:text-black hover:prose-a:text-blue-500"
			>
				<div class="mb-4 py-4 text-center leading-none">
					<div class="mb-2 text-gray-500">
						<FormattedDate date={pubDate} />
						{
							updatedDate && (
								<div class="italic">
									Last updated on <FormattedDate date={updatedDate} />
								</div>
							)
						}
					</div>
					<h1 class="m-0 mb-2">{title}</h1>
					<hr />
				</div>
				{
					headings && headings.length > 0 && (
						<nav class="mb-8 p-4 bg-gray-50 rounded-lg">
							<h2 class="text-lg font-bold mb-2">目次</h2>
							<ul class="list-disc list-outside space-y-1">
								{headings.map(
									(heading: { depth: number; slug: string; text: string }) => {
										const depthClass =
											{
												1: 'ml-0',
												2: 'ml-0',
												3: 'ml-2 md:ml-4',
												4: 'ml-4 md:ml-8',
												5: 'ml-6 md:ml-12',
												6: 'ml-8 md:ml-16',
											}[heading.depth as 1 | 2 | 3 | 4 | 5 | 6] || 'ml-0'

										return (
											<li class={`${depthClass} toc-level-${heading.depth}`}>
												<a
													href={`#${heading.slug}`}
													class="text-blue-600 hover:underline"
												>
													{heading.text}
												</a>
											</li>
										)
									},
								)}
							</ul>
						</nav>
					)
				}
				<slot />
			</div>
		</article>
	</main>
</BaseLayout>
