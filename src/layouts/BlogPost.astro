---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import FallbackImage from '../assets/blog-placeholder-1.jpg';
import SiteLogo from '../assets/icon.png';
import FormattedDate from '../components/FormattedDate.astro';
import { SITE_AUTHOR, SITE_TITLE } from '../consts';
import BaseLayout from './BaseLayout.astro';

type Props = CollectionEntry<'blog'>['data'] & {
  headings?: { depth: number; slug: string; text: string }[];
  postId?: string;
};

const { title, description, pubDate, updatedDate, heroImage, headings, postId } = Astro.props;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  image: [new URL(heroImage?.src || FallbackImage.src, Astro.url).toString()],
  datePublished: pubDate.toISOString(),
  ...(updatedDate ? { dateModified: updatedDate.toISOString() } : {}),
  author: [
    {
      '@type': 'Person',
      name: SITE_AUTHOR,
      url: new URL('/about', Astro.url).toString(),
    },
  ],
  publisher: {
    '@type': 'Organization',
    name: SITE_TITLE,
    logo: {
      '@type': 'ImageObject',
      url: new URL(SiteLogo.src, Astro.url).toString(),
    },
  },
};
---

<BaseLayout
	title={title}
	description={description}
	structuredData={structuredData}
>
	<main class="max-w-full! px-0! md:px-4!">
		<article>
			<div class="w-full">
				{
					heroImage && (
						<Image
							width={1020}
							height={510}
							src={heroImage}
							alt={`${title}のアイキャッチ画像`}
							class="block mx-auto rounded-xl shadow-md"
							loading="eager"
							fetchpriority="high"
							transition:name={postId ? `hero-${postId}` : undefined}
						/>
					)
				}
			</div>
			<div
				class="w-full max-w-[720px] mx-auto px-4 text-gray-700 dark:text-gray-300 prose dark:prose-invert md:prose-lg prose-headings:text-black dark:prose-headings:text-white hover:prose-a:text-blue-500"
			>
				<div class="mb-4 py-4 text-center leading-none">
					<div class="mb-2 text-gray-500">
						<FormattedDate date={pubDate} />
						{
							updatedDate && (
								<div class="italic">
									Last updated on <FormattedDate date={updatedDate} />
								</div>
							)
						}
					</div>
					<h1 class="m-0 mb-2">{title}</h1>
					<hr />
				</div>
				{
					headings && headings.length > 0 && (
						<nav class="mb-8 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
							<h2 class="text-lg font-bold mb-2">目次</h2>
							<ul class="list-disc list-outside space-y-1 text-gray-900 dark:text-gray-100">
								{headings.map(
									(heading: { depth: number; slug: string; text: string }) => {
										const depthClass =
											{
												1: 'ml-0',
												2: 'ml-0',
												3: 'ml-2 md:ml-4',
												4: 'ml-4 md:ml-8',
												5: 'ml-6 md:ml-12',
												6: 'ml-8 md:ml-16',
											}[heading.depth as 1 | 2 | 3 | 4 | 5 | 6] || 'ml-0'

										return (
											<li class={`${depthClass} toc-level-${heading.depth}`}>
												<a
													href={`#${heading.slug}`}
													class="text-blue-600 dark:text-blue-400 hover:underline"
												>
													{heading.text}
												</a>
											</li>
										)
									},
								)}
							</ul>
						</nav>
					)
				}
				<slot />
			</div>
		</article>
	</main>
</BaseLayout>
