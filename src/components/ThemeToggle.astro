---

---

<button
  id="theme-toggle"
  type="button"
  class="text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700/50 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center justify-center transition-colors"
  aria-label="テーマ切り替え"
  title="現在のテーマ"
>
  <svg
    id="theme-toggle-dark-icon"
    class="w-5 h-5 hidden"
    fill="currentColor"
    viewBox="0 0 20 20"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
    ></path>
  </svg>
  <svg
    id="theme-toggle-light-icon"
    class="w-5 h-5 hidden"
    fill="currentColor"
    viewBox="0 0 24 24"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"
    ></path>
  </svg>
  <svg
    id="theme-toggle-system-icon"
    class="w-5 h-5 hidden"
    fill="currentColor"
    viewBox="0 0 24 24"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      fill-rule="evenodd"
      d="M2.25 15a4.5 4.5 0 004.5 4.5H18a3.75 3.75 0 001.332-7.257 3 3 0 00-3.758-3.848 5.25 5.25 0 00-10.233 2.33A4.502 4.502 0 002.25 15z"
      clip-rule="evenodd"></path>
  </svg>
</button>

<script>
  let controller: AbortController | null = null

  function updateIcon(theme: string | null) {
    const darkIcon = document.getElementById('theme-toggle-dark-icon')
    const lightIcon = document.getElementById('theme-toggle-light-icon')
    const systemIcon = document.getElementById('theme-toggle-system-icon')

    darkIcon?.classList.add('hidden')
    lightIcon?.classList.add('hidden')
    systemIcon?.classList.add('hidden')

    if (theme === 'dark') {
      darkIcon?.classList.remove('hidden')
    } else if (theme === 'light') {
      lightIcon?.classList.remove('hidden')
    } else {
      systemIcon?.classList.remove('hidden')
    }
  }

  function applyTheme(theme: string | null) {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark')
    } else if (theme === 'light') {
      document.documentElement.classList.remove('dark')
    } else {
      // System
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    }
  }

  function getStoredTheme(): string | null {
    return localStorage.getItem('theme')
  }

  function initThemeToggle() {
    // 既存のイベントリスナーをクリーンアップ
    controller?.abort()
    controller = new AbortController()

    const themeToggleBtn = document.getElementById('theme-toggle')
    const currentTheme = getStoredTheme()

    // 初期表示
    updateIcon(currentTheme || 'system')

    if (themeToggleBtn) {
      themeToggleBtn.addEventListener(
        'click',
        function () {
          const themeCycle: Record<string, string> = {
            system: 'light',
            light: 'dark',
            dark: 'system',
          }
          const currentThemeName = getStoredTheme() || 'system'
          const nextTheme = themeCycle[currentThemeName]

          if (nextTheme === 'system') {
            localStorage.removeItem('theme')
          } else {
            localStorage.setItem('theme', nextTheme)
          }

          applyTheme(nextTheme === 'system' ? null : nextTheme)
          updateIcon(nextTheme)
        },
        { signal: controller.signal },
      )
    }
  }

  // 初回ロード時に初期化
  initThemeToggle()

  // View Transitions使用時のページ遷移後にも再初期化
  document.addEventListener('astro:after-swap', initThemeToggle)

  // システム設定の変更を監視して、設定が「system」の場合に反映
  window
    .matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', (e) => {
      if (!localStorage.getItem('theme')) {
        // Only react if theme is 'system'
        if (e.matches) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
      }
    })
</script>
